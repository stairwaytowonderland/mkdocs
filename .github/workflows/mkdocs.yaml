name: Publish Docs

# Ref: https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#filter-pattern-cheat-sheet
on:
  push:
    branches:
      - main
    # paths:
    #   - 'docs/**'
    #   - 'mkdocs/**'
    #   - 'README.md'
    #   - '.github/workflows/mkdocs.yaml'
  workflow_call:
  workflow_dispatch:

env:
  PYTHON_VERSION: 3.x

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-mkdocs:
    if: github.event.workflow_run.conclusion == 'success'

    name: Build MkDocs Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # cache: pip
          # cache-dependency-path: |
          #   requirements.txt

      # Some of the built-in plugins might depend on external libraries for efficient image processing
      # - name: Install dependencies
      #   # https://squidfunk.github.io/mkdocs-material/plugins/requirements/image-processing/#pngquant
      #   run: sudo apt-get install pngquant
      #   # https://github.com/domWalters/mkdocs-to-pdf
      #   run: sudo apt-get install weasyprint

      - name: Install Python dependencies
        run: |
          pip install -r mkdocs/requirements.txt

      - name: Build documentation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -a; . mkdocs/.env || "No mkdocs/.env file found"; set +a
          mkdocs build -f mkdocs/mkdocs.yml --clean
          mkdocs --version

      - name: Adjust permissions
        run: |
          chmod -c -R +rX mkdocs/dist/ | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: mkdocs/dist

      # Project Pages site files get deployed to a branch within the project repository (gh-pages by default)
      # https://www.mkdocs.org/user-guide/deploying-your-docs/#project-pages
      # - run: mkdocs gh-deploy --config-file mkdocs/mkdocs.yml --force

  deploy-mkdocs:
    name: Deploy MkDocs to GitHub Pages
    needs: build-mkdocs
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        # with:
        #   # Use `ref: gh-pages` if running `mkdocs gh-deploy`
        #   ref: gh-pages

      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Upload the pages artifact in the deploy job if running `mkdocs gh-deploy`
      # - name: Upload artifact
      #   uses: actions/upload-pages-artifact@v3
      #   with:
      #     path: mkdocs/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
